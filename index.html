<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™çˆªè®°è´¦ - Tiger Paw Account</title>
    <link rel="icon" type="image/jpeg" href="è€è™.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; background-color: #F8FAFC; }
        .card-elegant { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .dark { background-color: #0F172A; color: #F1F5F9; }
        .dark .card-elegant { background-color: #1E293B; border: 1px solid #334155; }
        .dark input, .dark textarea, .dark select { background-color: #334155; border-color: #475569; color: white; }
        
        .excel-row { 
            display: grid; 
            grid-template-columns: 40px 80px 70px 80px 1fr 100px 40px; 
            align-items: stretch;
            font-size: 12px; 
            border-bottom: 1px solid #e2e8f0;
            height: 32px; 
        }
        .dark .excel-row { border-bottom-color: #334155; }
        .excel-row:hover { background-color: #f1f5f9; }
        .dark .excel-row:hover { background-color: #1e293b; }
        
        .excel-cell {
            display: flex;
            align-items: center;
            padding: 0 8px;
            border-left: 1px solid #f1f5f9;
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
        }
        .dark .excel-cell { border-left-color: #334155; }
        .excel-cell:first-child { border-left: none; }

        .month-header {
            background-color: #f1f5f9;
            padding: 4px 12px;
            font-size: 11px;
            font-weight: bold;
            color: #64748b;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .dark .month-header { background-color: #334155; color: #94a3b8; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #batchBar { transition: transform 0.3s ease-in-out; transform: translateY(100%); z-index: 100; }
        #batchBar.active { transform: translateY(0); }
    </style>
</head>
<body class="p-4 md:p-6 min-h-screen transition-colors duration-300 pb-24">
    <div class="max-w-6xl mx-auto space-y-6">
        <div class="card-elegant p-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-6">
                <h1 class="text-lg font-bold i18n text-slate-800 dark:text-white" data-key="brandName">è´¦æœ¬å¥½æœ‹å‹</h1>
                <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                    <button onclick="setLang('cn')" class="lang-btn px-3 py-1 text-[10px] rounded-md" id="btn-cn">CN</button>
                    <button onclick="setLang('en')" class="lang-btn px-3 py-1 text-[10px] rounded-md" id="btn-en">EN</button>
                    <button onclick="setLang('kr')" class="lang-btn px-3 py-1 text-[10px] rounded-md" id="btn-kr">KR</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="rateInfo" class="text-[10px] text-slate-400 mr-2">æ±‡ç‡åŒæ­¥ä¸­...</div>
                <button onclick="toggleDark()" class="w-8 h-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" id="darkBtn">ğŸŒ™</button>
                <button onclick="rotateCurrency()" id="currencyBtn" class="px-4 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-bold w-20">CNY</button>
            </div>
        </div>

        <div class="card-elegant p-4">
            <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                <input type="date" id="iptDate" class="p-1.5 border rounded-lg text-xs outline-none">
                <input list="catHistory" id="iptCat" class="p-1.5 border rounded-lg text-xs outline-none i18n-ph" data-key="phCat">
                <input list="cityHistory" id="iptCity" class="p-1.5 border rounded-lg text-xs outline-none i18n-ph" data-key="phCity">
                <input type="text" id="iptDesc" class="p-1.5 border rounded-lg text-xs outline-none i18n-ph" data-key="phDesc">
                <input type="number" id="iptAmt" class="p-1.5 border rounded-lg text-xs outline-none i18n-ph" data-key="phAmt">
                <button onclick="addRecord()" id="btnAdd" class="bg-emerald-500 text-white rounded-lg font-bold text-xs i18n active:scale-95 transition-all" data-key="btnRecord">è®°ä¸€ç¬”</button>
            </div>
            <datalist id="catHistory"></datalist><datalist id="cityHistory"></datalist>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="card-elegant p-4 border-l-4 border-indigo-500">
                <p class="text-[10px] text-slate-400 uppercase i18n font-semibold" data-key="statDayTitle">ä»Šæ—¥ç»Ÿè®¡</p>
                <p class="text-xl font-bold text-slate-800 dark:text-white" id="statDay">Â¥0.00</p>
            </div>
            <div class="card-elegant p-4 border-l-4 border-emerald-500">
                <p class="text-[10px] text-slate-400 uppercase i18n font-semibold" data-key="statWeekTitle">æœ¬å‘¨ç»Ÿè®¡</p>
                <p class="text-xl font-bold text-slate-800 dark:text-white" id="statWeek">Â¥0.00</p>
            </div>
            <div class="card-elegant p-4 border-l-4 border-slate-800">
                <p class="text-[10px] text-slate-400 uppercase i18n font-semibold" data-key="statMonthTitle">æœ¬æœˆç»Ÿè®¡</p>
                <p class="text-xl font-bold text-slate-800 dark:text-white" id="statMonth">Â¥0.00</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card-elegant p-4 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-2">
                        <input type="text" id="searchBar" oninput="debounceSearch()" class="px-3 py-1.5 rounded-lg bg-slate-50 dark:bg-slate-800 text-xs w-48 outline-none i18n-ph" data-key="phSearch">
                        <select id="filterCity" onchange="render()" class="p-1.5 border rounded-lg text-xs outline-none bg-white dark:bg-slate-800">
                            <option value="">å…¨éƒ¨åŸå¸‚</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="date" id="rangeStart" onchange="render()" class="p-1 border rounded-lg text-[10px] outline-none">
                        <span class="text-slate-300 text-xs">-</span>
                        <input type="date" id="rangeEnd" onchange="render()" class="p-1 border rounded-lg text-[10px] outline-none">
                        <p class="text-xs font-bold text-indigo-600 ml-2" id="rangeResult">Â¥0.00</p>
                    </div>
                </div>

                <div class="card-elegant overflow-hidden">
                    <div class="month-header !cursor-default !bg-slate-200/50 dark:!bg-slate-800">
                        <div class="excel-row w-full font-bold !border-none !h-8 text-slate-500">
                            <span class="excel-cell justify-center">é€‰</span>
                            <span class="excel-cell">æ—¥æœŸ</span>
                            <span class="excel-cell">åˆ†ç±»</span>
                            <span class="excel-cell">åŸå¸‚</span>
                            <span class="excel-cell">å¤‡æ³¨</span>
                            <span class="excel-cell justify-end">é‡‘é¢</span>
                            <span class="excel-cell justify-center"></span>
                        </div>
                    </div>
                    <div id="recordList" class="max-h-[600px] overflow-y-auto overflow-x-auto"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="card-elegant p-4 h-48"><canvas id="barChart"></canvas></div>
                <div class="card-elegant p-4">
                    <textarea id="memoArea" oninput="saveMemo()" class="w-full h-32 p-2 text-xs bg-slate-50 dark:bg-slate-800/50 rounded-lg border-none focus:ring-1 focus:ring-indigo-500 outline-none resize-none i18n-ph" data-key="phMemo"></textarea>
                </div>
                <div class="card-elegant p-3 flex gap-2">
                    <button onclick="exportData()" class="flex-1 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-lg text-[10px] font-bold i18n" data-key="backup">å¤‡ä»½</button>
                    <button onclick="document.getElementById('importFile').click()" class="flex-1 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-lg text-[10px] font-bold i18n" data-key="import">å¯¼å…¥</button>
                </div>
                <div class="card-elegant p-4">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-4 text-center i18n" data-key="catAnalysisTitle">åŒºé—´åˆ†ç±»å æ¯”åˆ†æ</p>
                    <div id="pieStatus" class="text-[10px] text-slate-300 text-center py-10 i18n" data-key="pieWait">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©æ—¥æœŸåŒºé—´ä»¥æŸ¥çœ‹åˆ†æ</div>
                    <div id="pieContainer" class="h-64 hidden"><canvas id="pieChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="batchBar" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t p-3 flex justify-between items-center shadow-xl">
        <div class="flex items-center gap-4 ml-4">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-4 h-4 rounded">
            <span class="text-xs font-medium"><span id="selectedCount">0</span> å·²é€‰</span>
        </div>
        <div class="flex gap-2 mr-4">
            <button onclick="toggleBatchMode()" class="px-4 py-1.5 text-xs text-slate-500 i18n" data-key="cancel">å–æ¶ˆ</button>
            <button onclick="batchDelete()" class="px-6 py-1.5 text-xs bg-red-500 text-white rounded-lg font-bold">åˆ é™¤é€‰ä¸­</button>
        </div>
    </div>

    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">

    <script>
        // æ³¨å†Œæ’ä»¶ä»¥åœ¨é¥¼å›¾ä¸Šæ˜¾ç¤ºç™¾åˆ†æ¯”
        Chart.register(ChartDataLabels);

        const i18nDict = {
            cn: { brandName: "è™çˆªè®°è´¦", backup: "å¤‡ä»½", import: "å¯¼å…¥", statDayTitle: "ä»Šæ—¥ç»Ÿè®¡", statWeekTitle: "æœ¬å‘¨ç»Ÿè®¡", statMonthTitle: "æœ¬æœˆç»Ÿè®¡", rangeTitle: "åˆè®¡", phCat: "åˆ†ç±»", phCity: "åŸå¸‚", phDesc: "å¤‡æ³¨", phAmt: "é‡‘é¢", btnRecord: "è®°ä¸€ç¬”", phSearch: "ğŸ” æœç´¢...", phMemo: "è´¢åŠ¡å¤‡å¿˜å½•...", batchEdit: "ç®¡ç†", cancel: "å–æ¶ˆ", allCities: "å…¨éƒ¨åŸå¸‚", editPrompt: "ä¿®æ”¹", catAnalysisTitle: "åŒºé—´åˆ†ç±»å æ¯”", pieWait: "è¯·é€‰å¥½å¼€å§‹å’Œç»“æŸæ—¥æœŸ" },
            en: { brandName: "Tiger Paw Account", backup: "Export", import: "Import", statDayTitle: "Today", statWeekTitle: "This Week", statMonthTitle: "This Month", rangeTitle: "Total", phCat: "Cat", phCity: "City", phDesc: "Note", phAmt: "Amt", btnRecord: "Log", phSearch: "ğŸ” Search...", phMemo: "Memo...", batchEdit: "Edit", cancel: "Cancel", allCities: "All", editPrompt: "Edit", catAnalysisTitle: "Category Breakdown", pieWait: "Please select a date range" },
            kr: { brandName: "íƒ€ì´ê±° í¬ ê°€ê³„ë¶€", backup: "ë°±ì—…", import: "ê°€ì ¸ì˜¤ê¸°", statDayTitle: "ì˜¤ëŠ˜", statWeekTitle: "ì´ë²ˆ ì£¼", statMonthTitle: "ì´ë²ˆ ë‹¬", rangeTitle: "í•©ê³„", phCat: "ë¶„ë¥˜", phCity: "ë„ì‹œ", phDesc: "í•­ëª©", phAmt: "ê¸ˆé¢", btnRecord: "ê¸°ë¡", phSearch: "ğŸ” ê²€ìƒ‰...", phMemo: "ë©”ëª¨...", batchEdit: "ê´€ë¦¬", cancel: "ì·¨ì†Œ", allCities: "ì „ì²´", editPrompt: "ä¿®æ”¹", catAnalysisTitle: "ì¹´í…Œê³ ë¦¬ ë¶„ì„", pieWait: "ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì‹­ì‹œì˜¤" }
        };

        let expenses = JSON.parse(localStorage.getItem('acc_data_v3') || '[]');
        let currentLang = localStorage.getItem('acc_lang') || 'cn';
        let isDark = localStorage.getItem('acc_dark') === 'true';
        let curMode = 'CNY', rates = { USD: 7.02, KRW: 0.0053 };
        const SYMBOLS = { CNY: 'Â¥', USD: '$', KRW: 'â‚©' };
        let barChart = null, pieChart = null, isBatchMode = false;
        let searchTimeout = null, expandedMonths = new Set();

        function render() {
            const list = document.getElementById('recordList');
            const q = document.getElementById('searchBar').value.toLowerCase();
            const selectedCity = document.getElementById('filterCity').value;
            const rs = document.getElementById('rangeStart').value;
            const re = document.getElementById('rangeEnd').value;
            
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const currentMonthStr = todayStr.substring(0, 7);
            
            const dayOfWeek = now.getDay() || 7;
            const monday = new Date(now);
            monday.setDate(now.getDate() - dayOfWeek + 1);
            const mondayStr = monday.toISOString().split('T')[0];

            let dS=0, wS=0, mS=0, rS=0, mG={}, catsSet=new Set(), citySet=new Set(), rangeCats={};
            const monthsData = {};

            expenses.forEach(item => {
                const mon = item.date.substring(0,7);
                if(item.city) citySet.add(item.city);
                if(item.cat) catsSet.add(item.cat);
                if(item.date === todayStr) dS += item.amt;
                if(item.date >= mondayStr && item.date <= todayStr) wS += item.amt;
                if(mon === currentMonthStr) mS += item.amt;

                mG[mon] = (mG[mon] || 0) + item.amt;
                const inRange = (!rs || item.date >= rs) && (!re || item.date <= re);
                const cityMatch = !selectedCity || item.city === selectedCity;
                const searchMatch = !q || item.desc.toLowerCase().includes(q) || item.cat.toLowerCase().includes(q) || item.city.toLowerCase().includes(q) || item.date.includes(q);
                
                if(inRange && cityMatch) {
                    rS += item.amt;
                    if(rs && re) rangeCats[item.cat] = (rangeCats[item.cat] || 0) + item.amt;
                }
                if(searchMatch && inRange && cityMatch) {
                    if(!monthsData[mon]) monthsData[mon] = [];
                    monthsData[mon].push(item);
                }
            });

            document.getElementById('statDay').innerText = formatDisplay(dS);
            document.getElementById('statWeek').innerText = formatDisplay(wS);
            document.getElementById('statMonth').innerText = formatDisplay(mS);
            document.getElementById('rangeResult').innerText = formatDisplay(rS);
            updateDatalists(citySet, catsSet);
            updateCharts(mG, rangeCats, (rs && re));

            list.innerHTML = '';
            const sortedMonths = Object.keys(monthsData).sort().reverse();
            sortedMonths.forEach(mon => {
                const isExpanded = q || rs || re || selectedCity || expandedMonths.has(mon);
                const monthTotal = monthsData[mon].reduce((sum, i) => sum + i.amt, 0);
                const header = document.createElement('div');
                header.className = 'month-header';
                header.innerHTML = `<span>${mon} ${isExpanded ? 'â–¼' : 'â–¶'}</span><span>${formatDisplay(monthTotal)}</span>`;
                header.onclick = () => {
                    if(expandedMonths.has(mon)) expandedMonths.delete(mon);
                    else expandedMonths.add(mon);
                    render();
                };
                list.appendChild(header);

                if(isExpanded) {
                    const items = monthsData[mon].sort((a,b) => b.date.localeCompare(a.date));
                    items.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'excel-row';
                        const cColor = getCatColor(item.cat);
                        row.innerHTML = `
                            <div class="excel-cell justify-center">${isBatchMode ? `<input type="checkbox" class="item-checkbox w-3.5 h-3.5" value="${item.id}" onchange="updateCount()">` : 'â€¢'}</div>
                            <div class="excel-cell text-slate-400 tabular-nums" onclick="quickEdit('${item.id}', 'date')">${item.date.substring(5)}</div>
                            <div class="excel-cell" onclick="quickEdit('${item.id}', 'cat')"><span class="px-1 py-0.5 rounded-[4px] text-[9px] font-bold uppercase" style="background-color:${cColor}22; color:${cColor}">${item.cat}</span></div>
                            <div class="excel-cell text-slate-400 truncate pr-2" onclick="quickEdit('${item.id}', 'city')">${item.city || ''}</div>
                            <div class="excel-cell truncate font-medium text-slate-700 dark:text-slate-300" onclick="quickEdit('${item.id}', 'desc')">${item.desc}</div>
                            <div class="excel-cell justify-end font-bold tabular-nums hover:text-indigo-600" onclick="quickEdit('${item.id}', 'amt')">${formatDisplay(item.amt)}</div>
                            <div class="excel-cell justify-center">${!isBatchMode ? `<button onclick="deleteItem('${item.id}')" class="text-slate-300 hover:text-red-400">âœ•</button>` : ''}</div>
                        `;
                        list.appendChild(row);
                    });
                }
            });
        }

        function quickEdit(id, field) {
            if(isBatchMode) return;
            const item = expenses.find(e => e.id.toString() === id.toString());
            if(!item) return;
            let curVal = item[field];
            if(field === 'amt') curVal = (item.amt / (curMode==='USD'?rates.USD : (curMode==='KRW'?rates.KRW:1))).toFixed(2);
            const newVal = prompt(`${i18nDict[currentLang].editPrompt} ${field}:`, curVal);
            if(newVal !== null && newVal.trim() !== "") {
                if(field === 'amt') {
                    if(!isNaN(parseFloat(newVal))) item.amt = parseFloat(newVal) * (curMode==='USD'?rates.USD : (curMode==='KRW'?rates.KRW:1));
                } else { item[field] = newVal.trim(); }
                localStorage.setItem('acc_data_v3', JSON.stringify(expenses));
                render();
            }
        }

        function formatDisplay(v) {
            let conv = v / (curMode==='USD'?rates.USD : (curMode==='KRW'?rates.KRW:1));
            return SYMBOLS[curMode] + conv.toLocaleString(undefined, { minimumFractionDigits: curMode==='KRW'?0:2, maximumFractionDigits: curMode==='KRW'?0:2 });
        }
        function rotateCurrency() { const seq=['CNY','USD','KRW']; curMode=seq[(seq.indexOf(curMode)+1)%3]; document.getElementById('currencyBtn').innerText=curMode; render(); }
        function setLang(l) { currentLang = l; localStorage.setItem('acc_lang', l); updateUI(); }
        function updateUI() {
            document.querySelectorAll('.i18n').forEach(el => el.innerText = i18nDict[currentLang][el.getAttribute('data-key')]);
            document.querySelectorAll('.i18n-ph').forEach(el => el.placeholder = i18nDict[currentLang][el.getAttribute('data-key')]);
            document.querySelectorAll('.lang-btn').forEach(btn => btn.className = `lang-btn px-3 py-1 text-[10px] font-medium rounded-md ${btn.id==='btn-'+currentLang?'bg-indigo-600 text-white shadow-sm':'text-slate-400 hover:text-slate-600'}`);
            render();
        }
        function toggleDark() { isDark=!isDark; localStorage.setItem('acc_dark', isDark); document.body.classList.toggle('dark', isDark); document.getElementById('darkBtn').innerText=isDark?"â˜€ï¸":"ğŸŒ™"; }
        function addRecord() {
            const d=document.getElementById('iptDate').value, c=document.getElementById('iptCat').value.trim(), city=document.getElementById('iptCity').value.trim(), t=document.getElementById('iptDesc').value, a=parseFloat(document.getElementById('iptAmt').value);
            if(!d || isNaN(a)) return;
            let cny = (curMode==='USD') ? a*rates.USD : (curMode==='KRW' ? a*rates.KRW : a);
            expenses.push({ id: Date.now()+Math.random(), date: d, cat: c||'Other', city, desc: t||'-', amt: cny });
            localStorage.setItem('acc_data_v3', JSON.stringify(expenses));
            document.getElementById('iptDesc').value = ''; document.getElementById('iptAmt').value = '';
            render();
        }
        function deleteItem(id) { if(confirm('ç¡®è®¤åˆ é™¤å—ï¼Ÿ')) { expenses=expenses.filter(e=>e.id.toString()!==id.toString()); localStorage.setItem('acc_data_v3', JSON.stringify(expenses)); render(); } }

        function updateCharts(mG, rangeCats, showPie) {
            // æŸ±çŠ¶å›¾
            const bCtx=document.getElementById('barChart').getContext('2d'), bKeys=Object.keys(mG).sort();
            const bData=bKeys.map(k=> (curMode==='USD'?mG[k]/rates.USD : (curMode==='KRW'?mG[k]/rates.KRW:mG[k])));
            if(barChart) barChart.destroy();
            barChart = new Chart(bCtx, { type:'bar', data:{labels:bKeys, datasets:[{data:bData, backgroundColor:'#4F46E5', borderRadius:4}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, datalabels: { display: false }}} });

            // é¥¼å›¾
            const pStatus = document.getElementById('pieStatus');
            const pContainer = document.getElementById('pieContainer');
            
            if(!showPie || Object.keys(rangeCats).length === 0) {
                pStatus.classList.remove('hidden');
                pContainer.classList.add('hidden');
                return;
            }
            pStatus.classList.add('hidden');
            pContainer.classList.remove('hidden');
            const pCtx=document.getElementById('pieChart').getContext('2d'), pLabels=Object.keys(rangeCats), pData=Object.values(rangeCats);
            const total = pData.reduce((a,b)=>a+b, 0);

            if(pieChart) pieChart.destroy();
            pieChart = new Chart(pCtx, { 
                type: 'doughnut', 
                data: {
                    labels: pLabels, 
                    datasets: [{
                        data: pData, 
                        backgroundColor: pLabels.map(l=>getCatColor(l)), 
                        borderWidth: 0
                    }]
                }, 
                options: {
                    responsive: true, 
                    maintainAspectRatio: false, 
                    layout: { padding: 25 },
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                        tooltip: { enabled: true },
                        // ç™¾åˆ†æ¯”æ ‡ç­¾é…ç½®
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value) => {
                                let percentage = (value / total * 100).toFixed(1) + "%";
                                return percentage;
                            },
                            // åªæœ‰å½“æ¯”ä¾‹å¤§äº 5% æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼Œé˜²æ­¢å¤ªæŒ¤
                            display: (context) => {
                                return context.dataset.data[context.dataIndex] / total > 0.05;
                            }
                        }
                    }
                } 
            });
        }

        function updateDatalists(citySet, catsSet) {
            const cDl=document.getElementById('cityHistory'), ctDl=document.getElementById('catHistory'), fCity=document.getElementById('filterCity'), oldCity=fCity.value;
            cDl.innerHTML=''; ctDl.innerHTML=''; fCity.innerHTML=`<option value="">å…¨éƒ¨åŸå¸‚</option>`;
            Array.from(citySet).sort().forEach(c => { cDl.innerHTML+=`<option value="${c}">`; fCity.innerHTML+=`<option value="${c}" ${c===oldCity?'selected':''}>${c}</option>`; });
            catsSet.forEach(c => ctDl.innerHTML+=`<option value="${c}">`);
        }
        const getCatColor = (cat) => `hsl(${Math.abs(cat.split('').reduce((a,b)=>a+b.charCodeAt(0),0)) % 360}, 60%, 65%)`;
        function saveMemo() { localStorage.setItem('acc_memo', document.getElementById('memoArea').value); }
        function toggleBatchMode() { isBatchMode = !isBatchMode; document.getElementById('batchBar').classList.toggle('active', isBatchMode); render(); }
        function updateCount() { document.getElementById('selectedCount').innerText = document.querySelectorAll('.item-checkbox:checked').length; }
        function toggleSelectAll() { document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = document.getElementById('selectAll').checked); updateCount(); }
        function batchDelete() { const checked = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value); if(checked.length > 0 && confirm('ç¡®è®¤åˆ é™¤å—ï¼Ÿ')) { expenses = expenses.filter(e => !checked.includes(e.id.toString())); localStorage.setItem('acc_data_v3', JSON.stringify(expenses)); toggleBatchMode(); } }
        function exportData() { const b=new Blob([JSON.stringify(expenses)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`Wallet_Buddy.json`; a.click(); }
        function importData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { try { expenses = [...expenses, ...JSON.parse(e.target.result)]; localStorage.setItem('acc_data_v3', JSON.stringify(expenses)); render(); } catch (err) { alert("Error"); } };
            reader.readAsText(file);
        }
        function debounceSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(render, 250); }
        async function fetchRates() { try { const res = await fetch('https://open.er-api.com/v6/latest/CNY'); const data = await res.json(); if (data?.rates) { rates.USD = 1/data.rates.USD; rates.KRW = 1/data.rates.KRW; document.getElementById('rateInfo').innerText = `1 USD â‰ˆ ${rates.USD.toFixed(2)} CNY`; } } catch (e) {} }

        fetchRates(); document.getElementById('iptDate').valueAsDate = new Date(); 
        document.getElementById('memoArea').value = localStorage.getItem('acc_memo') || ''; updateUI();
    </script>
</body>
</html>
