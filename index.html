<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦æœ¬å¥½æœ‹å‹ - Wallet Buddy Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* å¼ºåˆ¶ä½¿ç”¨ç®€çº¦å¤§æ°”çš„ç³»ç»Ÿå­—ä½“ */
        body { 
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", "Helvetica Neue", sans-serif;
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.01em;
            background-color: #F8FAFC;
        }
        
        /* ç»Ÿä¸€å“ç‰Œè‰²ï¼šåªä¿ç•™ä¸€ç§é«˜çº§ç»¿ */
        :root { --brand-green: #10B981; --brand-blue: #4F46E5; }

        .card-elegant { 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-elegant:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08); }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .dark { background-color: #0F172A; color: #F1F5F9; }
        .dark .card-elegant { background-color: #1E293B; box-shadow: none; border: 1px solid #334155; }
        .dark input, .dark select { background-color: #334155; border-color: #475569; color: white; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen transition-colors duration-300" id="bodyTag">
    <div class="max-w-6xl mx-auto space-y-8">
        
        <div class="card-elegant p-5 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight i18n" data-key="brandName">è´¦æœ¬å¥½æœ‹å‹</h1>
                <div class="flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                    <button onclick="setLang('cn')" class="lang-btn px-3 py-1 text-[11px] font-medium rounded-md transition-all" id="btn-cn">CN</button>
                    <button onclick="setLang('en')" class="lang-btn px-3 py-1 text-[11px] font-medium rounded-md transition-all" id="btn-en">EN</button>
                    <button onclick="setLang('kr')" class="lang-btn px-3 py-1 text-[11px] font-medium rounded-md transition-all" id="btn-kr">KR</button>
                </div>
            </div>

            <div id="weatherDisplay" class="flex items-center gap-2 px-4 py-1.5 bg-emerald-50 dark:bg-emerald-900/20 rounded-full border border-emerald-100 dark:border-emerald-800">
                <span id="weatherIcon" class="text-sm">ğŸŒ</span>
                <span id="weatherText" class="text-[11px] font-medium text-emerald-600 dark:text-emerald-400">Loading...</span>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleDark()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition" id="darkBtn">ğŸŒ™</button>
                <div class="h-6 w-[1px] bg-slate-200 mx-1"></div>
                <button onclick="rotateCurrency()" id="currencyBtn" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-sm active:scale-95 transition-all w-24">CNY</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card-elegant p-6 border-l-4 border-indigo-500">
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-1 i18n" data-key="statDayTitle">ä»Šæ—¥æ¶ˆè€—</p>
                <p class="text-3xl font-bold text-slate-800 dark:text-white" id="statDay">Â¥0.00</p>
            </div>
            <div class="card-elegant p-6 border-l-4 border-emerald-500">
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-1 i18n" data-key="statWeekTitle">æœ¬å‘¨æ¶ˆè€—</p>
                <p class="text-3xl font-bold text-slate-800 dark:text-white" id="statWeek">Â¥0.00</p>
            </div>
            <div class="card-elegant p-6 border-l-4 border-slate-800">
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wider mb-1 i18n" data-key="statMonthTitle">æœ¬æœˆæ¶ˆè€—</p>
                <p class="text-3xl font-bold text-slate-800 dark:text-white" id="statMonth">Â¥0.00</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="card-elegant p-6">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <input type="date" id="iptDate" class="p-2.5 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 ring-indigo-500/20 transition-all">
                        <div class="relative">
                            <input list="catHistory" id="iptCat" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm outline-none i18n-ph" data-key="phCat">
                            <datalist id="catHistory"></datalist>
                        </div>
                        <input type="text" id="iptDesc" class="p-2.5 border border-slate-200 rounded-xl text-sm outline-none i18n-ph" data-key="phDesc">
                        <input type="number" id="iptAmt" class="p-2.5 border border-slate-200 rounded-xl text-sm outline-none i18n-ph" data-key="phAmt">
                        <button onclick="addRecord()" class="bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold text-sm transition-all i18n" data-key="btnRecord">è®°å½•</button>
                    </div>
                </div>

                <div class="card-elegant p-6 bg-slate-50 border-none">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white dark:bg-slate-700 rounded-2xl flex items-center justify-center shadow-sm">ğŸ“…</div>
                            <div>
                                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest i18n" data-key="rangeTitle">è‡ªå®šä¹‰åŒºé—´ç»Ÿè®¡</p>
                                <p class="text-2xl font-bold text-indigo-600 dark:text-indigo-400" id="rangeResult">Â¥0.00</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-700 p-2 rounded-xl border border-slate-100 dark:border-slate-600">
                            <input type="date" id="rangeStart" onchange="render()" class="bg-transparent border-none text-xs outline-none">
                            <span class="text-slate-300">è‡³</span>
                            <input type="date" id="rangeEnd" onchange="render()" class="bg-transparent border-none text-xs outline-none">
                        </div>
                    </div>
                </div>

                <div class="card-elegant overflow-hidden">
                    <div class="p-5 border-b border-slate-50 dark:border-slate-800 flex justify-between items-center bg-white dark:bg-slate-900">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest i18n" data-key="listTitle">æµæ°´è®°å½•</span>
                        <input type="text" id="searchBar" oninput="render()" class="px-4 py-1.5 rounded-xl bg-slate-50 dark:bg-slate-800 border-none text-xs w-48 outline-none i18n-ph" data-key="phSearch">
                    </div>
                    <div id="recordList" class="divide-y divide-slate-50 dark:divide-slate-800 max-h-[600px] overflow-y-auto no-scrollbar"></div>
                </div>
            </div>

            <div class="space-y-8">
                <div class="card-elegant p-6">
                    <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-6 text-center i18n" data-key="chartTitle">æœˆåº¦ç´¯è®¡å¯¹æ¯”</p>
                    <div class="h-64"><canvas id="barChart"></canvas></div>
                </div>
                
                <div class="card-elegant p-4">
                    <div class="flex gap-3">
                        <button onclick="exportData()" class="flex-1 py-2 text-[11px] font-bold bg-slate-100 dark:bg-slate-800 rounded-xl hover:bg-slate-200 transition i18n" data-key="backup">å¤‡ä»½ JSON</button>
                        <button onclick="document.getElementById('importFile').click()" class="flex-1 py-2 text-[11px] font-bold bg-slate-100 dark:bg-slate-800 rounded-xl hover:bg-slate-200 transition i18n" data-key="import">è¿˜åŸæ•°æ®</button>
                    </div>
                </div>

                <div id="historyMonths" class="card-elegant divide-y divide-slate-50 dark:divide-slate-800 overflow-hidden"></div>
            </div>
        </div>
    </div>

    <script>
        const i18nDict = {
            cn: { brandName: "è´¦æœ¬å¥½æœ‹å‹", backup: "å¤‡ä»½", import: "å¯¼å…¥", statDayTitle: "ä»Šæ—¥æ¶ˆè€—", statWeekTitle: "æœ¬å‘¨æ¶ˆè€—", statMonthTitle: "æœ¬æœˆæ¶ˆè€—", rangeTitle: "é€‰ä¸­åŒºé—´æ€»è®¡", phCat: "åˆ†ç±» (å¦‚: é¤é¥®)", phDesc: "é¡¹ç›®å¤‡æ³¨", phAmt: "é‡‘é¢", btnRecord: "è®°å½•", listTitle: "è¯¦ç»†æµæ°´", chartTitle: "æœˆåº¦æ¶ˆè´¹è¶‹åŠ¿", phSearch: "ğŸ” æœç´¢...", del: "åˆ é™¤", confDel: "ç¡®å®šåˆ é™¤ï¼Ÿ", editPrompt: "ä¿®æ”¹é‡‘é¢", importConf: "åˆå¹¶ç°æœ‰æ•°æ®ï¼Ÿ" },
            en: { brandName: "Wallet Buddy", backup: "Export", import: "Import", statDayTitle: "Today", statWeekTitle: "Weekly", statMonthTitle: "Monthly", rangeTitle: "Range Total", phCat: "Category", phDesc: "Note", phAmt: "Amount", btnRecord: "Log", listTitle: "Records", chartTitle: "Monthly Trends", phSearch: "ğŸ” Search...", del: "Del", confDel: "Delete?", editPrompt: "Edit", importConf: "Merge data?" },
            kr: { brandName: "ê°€ê³„ë¶€ ì¹œêµ¬", backup: "ë°±ì—…", import: "ê°€ì ¸ì˜¤ê¸°", statDayTitle: "ì˜¤ëŠ˜", statWeekTitle: "ì´ë²ˆ ì£¼", statMonthTitle: "ì´ë²ˆ ë‹¬", rangeTitle: "ê¸°ê°„ í•©ê³„", phCat: "ë¶„ë¥˜", phDesc: "í•­ëª©", phAmt: "ê¸ˆì•¡", btnRecord: "ê¸°ë¡", listTitle: "ë‚´ì—­", chartTitle: "ì›”ê°„ ì¶”ì„¸", phSearch: "ğŸ” ê²€ìƒ‰...", del: "ì‚­ì œ", confDel: "ì‚­ì œí• ê¹Œìš”?", editPrompt: "ê¸ˆì•¡ ìˆ˜ì •", importConf: "ë°ì´í„° í•©ì¹˜ê¸°?" }
        };

        let currentLang = localStorage.getItem('acc_lang') || 'cn';
        let expenses = JSON.parse(localStorage.getItem('acc_data_v3') || '[]');
        let isDark = localStorage.getItem('acc_dark') === 'true';
        let curMode = 'CNY';
        const SYMBOLS = { CNY: 'Â¥', USD: '$', KRW: 'â‚©' };
        let chartInstance = null;

        function toggleDark() { isDark = !isDark; localStorage.setItem('acc_dark', isDark); applyTheme(); }
        function applyTheme() {
            document.body.classList.toggle('dark', isDark);
            document.getElementById('darkBtn').innerText = isDark ? "â˜€ï¸" : "ğŸŒ™";
            updateWeather(); render();
        }

        async function updateWeather() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                    const data = await res.json();
                    const temp = data.current_weather.temperature;
                    const code = data.current_weather.weathercode;
                    let icon = code > 50 ? "ğŸŒ§ï¸" : "â˜€ï¸";
                    document.getElementById('weatherIcon').innerText = icon;
                    document.getElementById('weatherText').innerText = `${temp}Â°C ${isDark ? '| Night' : '| Day'}`;
                } catch(e) {}
            });
        }

        function setLang(l) { currentLang = l; localStorage.setItem('acc_lang', l); updateUI(); }
        function updateUI() {
            document.querySelectorAll('.i18n').forEach(el => el.innerText = i18nDict[currentLang][el.getAttribute('data-key')]);
            document.querySelectorAll('.i18n-ph').forEach(el => el.placeholder = i18nDict[currentLang][el.getAttribute('data-key')]);
            document.querySelectorAll('.lang-btn').forEach(btn => {
                const isActive = btn.id === 'btn-' + currentLang;
                btn.className = `lang-btn px-3 py-1 text-[11px] font-medium rounded-md transition-all ${isActive ? 'bg-indigo-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`;
            });
            render();
        }

        function rotateCurrency() {
            const seq = ['CNY', 'USD', 'KRW'];
            curMode = seq[(seq.indexOf(curMode) + 1) % 3];
            document.getElementById('currencyBtn').innerText = curMode;
            render();
        }

        function toBase(v) { return curMode==='CNY'?v : (curMode==='USD'?v*7.25 : (v/1350)*7.25); }
        function fromBase(v) { return curMode==='CNY'?v : (curMode==='USD'?v/7.25 : (v/7.25)*1350); }

        function addRecord() {
            const d = document.getElementById('iptDate').value, c = document.getElementById('iptCat').value.trim(), t = document.getElementById('iptDesc').value, a = parseFloat(document.getElementById('iptAmt').value);
            if(!d || isNaN(a)) return;
            expenses.push({ id: Date.now(), date: d, cat: c || 'Other', desc: t || '-', amt: toBase(a) });
            localStorage.setItem('acc_data_v3', JSON.stringify(expenses));
            document.getElementById('iptCat').value = ''; document.getElementById('iptDesc').value = ''; document.getElementById('iptAmt').value = '';
            render();
        }

        function deleteItem(id) { if(confirm(i18nDict[currentLang].confDel)) { expenses = expenses.filter(e => e.id !== id); localStorage.setItem('acc_data_v3', JSON.stringify(expenses)); render(); } }
        function editItem(id) {
            const item = expenses.find(e => e.id === id);
            const newVal = prompt(i18nDict[currentLang].editPrompt, fromBase(item.amt).toFixed(curMode==='KRW'?0:2));
            if (newVal !== null) { item.amt = toBase(parseFloat(newVal)); localStorage.setItem('acc_data_v3', JSON.stringify(expenses)); render(); }
        }

        function render() {
            const list = document.getElementById('recordList'), hList = document.getElementById('historyMonths'), datalist = document.getElementById('catHistory'), q = document.getElementById('searchBar').value.toLowerCase();
            list.innerHTML = ''; hList.innerHTML = ''; datalist.innerHTML = '';
            const sym = SYMBOLS[curMode], fmt = (v) => sym + fromBase(v).toLocaleString(undefined, {minimumFractionDigits: curMode==='KRW'?0:2});
            
            const now = new Date(), today = now.toISOString().split('T')[0], rs = document.getElementById('rangeStart').value, re = document.getElementById('rangeEnd').value;
            let dS = 0, wS = 0, mS = 0, rS = 0, mG = {}, catsSet = new Set();

            expenses.sort((a,b) => b.date.localeCompare(a.date)).forEach(item => {
                const mon = item.date.substring(0, 7), isMatch = item.desc.toLowerCase().includes(q) || item.cat.toLowerCase().includes(q);
                if(item.date === today) dS += item.amt;
                if(mon === today.substring(0, 7)) mS += item.amt;
                if(rs && re && item.date >= rs && item.date <= re) rS += item.amt;
                mG[mon] = (mG[mon] || 0) + item.amt;
                if(item.cat) catsSet.add(item.cat);

                if(isMatch) {
                    list.innerHTML += `<div class="p-4 flex justify-between items-center hover:bg-slate-50/50 dark:hover:bg-slate-800/50 transition-colors">
                        <div class="flex items-center gap-4">
                            <span class="px-2.5 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 text-[10px] font-bold rounded-lg uppercase tracking-wider">${item.cat}</span>
                            <div><p class="font-bold text-slate-700 dark:text-slate-200 text-sm">${item.desc}</p><p class="text-[10px] text-slate-400 font-medium mt-0.5">${item.date}</p></div>
                        </div>
                        <div class="flex items-center gap-5"><span onclick="editItem(${item.id})" class="font-bold text-slate-800 dark:text-white text-base cursor-pointer hover:text-indigo-600 transition-colors">${fmt(item.amt)}</span>
                        <button onclick="deleteItem(${item.id})" class="text-slate-300 hover:text-red-400 transition-colors">âœ•</button></div>
                    </div>`;
                }
            });

            catsSet.forEach(c => datalist.innerHTML += `<option value="${c}">`);
            Object.keys(mG).sort().reverse().forEach(m => hList.innerHTML += `<div class="p-3.5 flex justify-between text-xs font-medium"><span>${m}</span><span class="font-bold text-slate-700 dark:text-slate-200">${fmt(mG[m])}</span></div>`);
            
            document.getElementById('statDay').innerText = fmt(dS);
            document.getElementById('statMonth').innerText = fmt(mS);
            document.getElementById('rangeResult').innerText = fmt(rS);
            updateChart(mG);
        }

        function updateChart(g) {
            const ctx = document.getElementById('barChart').getContext('2d'), keys = Object.keys(g).sort(), data = keys.map(k => fromBase(g[k]));
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar', data: { labels: keys, datasets: [{ data: data, backgroundColor: '#4F46E5', borderRadius: 8, barThickness: 24 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, 
                scales: { 
                    y: { grid: { color: isDark?'#334155':'#F1F5F9' }, ticks: { font: { size: 9 } } }, 
                    x: { grid: { display: false }, ticks: { font: { size: 9 } } } 
                } }
            });
        }

        function exportData() { const b = new Blob([JSON.stringify(expenses)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `Wallet_Buddy_Backup.json`; a.click(); }
        function importData(e) { const r = new FileReader(); r.onload = (x) => { expenses = [...expenses, ...JSON.parse(x.target.result)]; localStorage.setItem('acc_data_v3', JSON.stringify(expenses)); render(); }; r.readAsText(e.target.files[0]); }

        document.getElementById('iptDate').valueAsDate = new Date();
        applyTheme(); updateUI();
    </script>
</body>
</html>
